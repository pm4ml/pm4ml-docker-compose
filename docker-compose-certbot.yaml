services:
  certbot:
    image: certbot/certbot
    ports:
      - "80:80"
    volumes:
      - ./docker/certbot/etc:/etc/letsencrypt
    command:
      - certonly
      - --standalone
      - --force-renewal
      - --email
      - contact@${PM4ML_DOMAIN}
      - --agree-tos
      - --no-eff-email
      - -d
      - portal.${PM4ML_DOMAIN}

  cert-combiner:
    image: alpine:latest
    volumes:
      - ./docker/certbot/etc:/etc/letsencrypt
      - ./docker/certbot/certs:/output
    command:
      - sh
      - -c
      - |
        cat /etc/letsencrypt/live/portal.${PM4ML_DOMAIN}/fullchain.pem \
            /etc/letsencrypt/live/portal.${PM4ML_DOMAIN}/privkey.pem \
            > /output/portal.pem
        chmod 644 /output/portal.pem
        echo "Certificate combined successfully"
    depends_on:
      - certbot

  certbot-renew:
    image: certbot/certbot
    volumes:
      - ./docker/certbot/etc:/etc/letsencrypt
      - ./docker/certbot/certs:/output
    entrypoint: /bin/sh
    command:
      - -c
      - |
        trap exit TERM
        while :; do
          certbot renew --quiet
          RENEWAL_EXIT=$?
          if [ $RENEWAL_EXIT -eq 0 ]; then
            CERT_PATH="/etc/letsencrypt/live/portal.${PM4ML_DOMAIN}"
            if [ -f "$CERT_PATH/fullchain.pem" ] && [ -f "$CERT_PATH/privkey.pem" ]; then
              cat "$CERT_PATH/fullchain.pem" "$CERT_PATH/privkey.pem" > /output/portal.pem
              if [ $? -eq 0 ]; then
                chmod 644 /output/portal.pem
              else
                echo "Error: Failed to combine certificates"
              fi
            else
              echo "Error: Certificate files not found in $CERT_PATH"
            fi
          fi
          sleep 12h & wait $${!}
        done
    depends_on:
      - cert-combiner
    restart: unless-stopped
